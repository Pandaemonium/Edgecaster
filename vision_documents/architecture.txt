Project Architecture Reference
==============================

Purpose
-------
This document is the first place to check when adding or modifying features. It describes where each responsibility lives, how data flows, and highlights any current fragmentation so we avoid duplicating logic in different places.

High-Level Overview
-------------------
- Runtime loop & scenes: `edgecaster/scenes/` (scene manager, dungeon, world map, character creation, fractal editor, options, urgent messages, etc.).
- Rendering: `edgecaster/render/` (ASCII/pygame renderer, UI, ability bar, cursor/zoom logic).
- Game state & systems: `edgecaster/game.py` (core game state, pattern system integration, turns/energy), `edgecaster/systems/` (actions, ai, effects, turns).
- Data/content: `edgecaster/content/` (factions, items, npcs, enemies YAML, etc.).
- Patterns/fractals: `edgecaster/patterns/` (builder, activation, library, queries).
- Map generation: `edgecaster/mapgen.py`, world map scene, fractal map tools in `tools/`.
- Enemies: data-driven templates in `edgecaster/content/enemies.yaml`, loader/factory in `edgecaster/enemies/`.
- Entities/Actors: `edgecaster/state/entities.py`, `edgecaster/state/actors.py`, plus supporting state in `edgecaster/state/`.
- Tools/scripts: `v1/Edgecaster/tools/` (julia path/miner/sweeper, thumbnails) — generated artifacts should be ignored in git.
- Vision docs: `vision_documents/` (strategy references: architecture, map generation, enemy strategy, fractal lab).

Key Responsibilities by Area
----------------------------
- Scenes (`edgecaster/scenes/`):
  - `manager.py`: scene stack, main loop dispatch.
  - `dungeon.py`: main play scene (local map, input dispatch to game, urgent messages).
  - `world_map_scene.py`: overworld map view, fast travel.
  - `character_creation_scene.py`: character creation flow.
  - `fractal_editor_scene.py`: full-screen fractal editor (custom pattern builder).
  - `dialogue_scene.py`, `urgent_message_scene.py`: modal interactions/messages.

- Rendering (`edgecaster/render/`):
  - `ascii.py`: main renderer, map drawing, UI (ability bar, HUD, message log), zoom, cursor, world map UI.
  - `ui.py`: shared UI helpers.

- Game core (`edgecaster/game.py`):
  - Holds world/levels, actors, pattern state, parameters, coherence/mana/HP, turn processing entry points.
  - Pattern operations: queue fractals/activations, time cost.
  - Level transitions (stairs, world map requests).
  - Custom patterns list and ability bar signature invalidation.

- Systems (`edgecaster/systems/`):
  - `actions.py`: actions that actors can perform (movement, attacks, abilities).
  - `ai.py`: behavior scripts to choose next action (behavior ids referenced by actors/enemies).
  - `effects.py`, `turns.py`: effect processing, turn/energy handling.

- Entities & Actors (`edgecaster/state/`):
  - `entities.py`: base Entity (id, name, pos, glyph, color, kind, tags, statuses).
  - `actors.py`: Actor extends Entity with Stats, faction, actions, disposition/affiliations.
  - `world.py`, `patterns.py`, `saves.py`, `factions.py`, etc.: supporting state containers.

- Content/data (`edgecaster/content/`):
  - `factions_data.py`, `items.py`, `npcs.py`, `actions_catalog.py`, `monsters.py` (legacy stub).
  - **Enemies**: `enemies.yaml` (templates; ids, glyph, color, stats, faction, ai, tags).

- Enemies (`edgecaster/enemies/`):
  - `templates.py`: EnemyTemplate dataclass, YAML loader, registry.
  - `factory.py`: spawn_enemy(tmpl_id, pos) builds Actor with stats/faction/ai tags.
  - Integration: AI behavior_id in tags → handled by `systems/ai.py`; spawning hooked via mapgen/spawner (to be wired).

- Patterns (`edgecaster/patterns/`):
  - `builder.py`, `activation.py`, `library.py`, `queries.py`: pattern representation, fractal generators, activations.

- Map generation / world map:
  - `mapgen.py`: local zone generation; fractal-overworld integration.
  - `world_map_scene.py`: rendering and interaction with overmap, fast travel.
  - `tools/`: julia path/miner/sweeper; generated thumbnails are not source.

- Fractal editor(s):
  - Current: `fractal_editor_scene.py` (full-screen, modes: draw/delete/flip, undo, per-edge gradient). Used for custom patterns, invoked from dungeon or lab.
  - Legacy/chargen custom fractal: character creation uses a simplified custom fractal flow; goal is to reuse the scene for both to avoid duplication.

Current Fragmentation / Watchpoints
-----------------------------------
- **Nested repository**: `C:\Games\Edgecaster\Edgecaster` is an old embedded git repo; should be ignored/removed from index to avoid conflicts.
- **Generated thumbnails**: `v1/Edgecaster/tools/thumbnails/` and `path_thumbnails/` are outputs; ensure they stay in `.gitignore`.
- **Enemy data**: legacy monster manual was removed; enemy data now lives in `content/enemies.yaml` with loader/factory in `edgecaster/enemies/`. Use the YAML → templates → factory path exclusively.
- **Fractal editors**: character creation has a custom fractal flow; a more capable editor lives in `fractal_editor_scene.py`. Goal: single editor scene reused in both places to avoid duplicate logic.
- **Actions/AI**: actions live in `systems/actions.py`; AI scripts in `systems/ai.py`. Friend’s note: actors (imps/player) are “Actors” in the energy queue; some entities (berries, etc.) are plain Entities. Keep behaviors referenced by id in data (enemies.yaml) to avoid subclass sprawl.
- **Ability bar**: currently built in `render/ascii.py`, keyed off unlocked generators/illuminator; now supports multiple custom patterns. If adding new special actions, extend the builder there rather than duplicating UI elsewhere.

Direction & Guidelines
----------------------
- Data-first content: use YAML/JSON in `content/` (enemies, factions, items, actions catalog) and load via registries.
- Behavior by id: AI and actions are selected by string ids; avoid subclassing per-enemy. Add behaviors to `systems/ai.py`, actions to `systems/actions.py`.
- Single source of truth:
  - Enemy templates: `content/enemies.yaml` → `enemies/templates.py` → `enemies/factory.py`.
  - Fractal editor: `scenes/fractal_editor_scene.py` reused wherever custom patterns are edited.
  - Map/overmap: `mapgen.py` + `world_map_scene.py`.
- Keep generated assets out of git: thumbnails, screenshots, caches go to ignored paths.
- When adding features:
  - Find the owning layer here first to avoid duplication.
  - For UI, prefer extending renderer/scene rather than creating parallel interfaces.
  - For game logic, prefer extending systems (actions/ai/effects) and data (content) rather than branching game.py.
- Entity-centric model: everything can be an `Entity` (walls, items, props, actors). Only `Actor` instances participate in turns/energy; others stay lightweight. Use tags/components (`blocks_movement`, `pickupable`, `flammable`, etc.) and `kind` to drive systems rather than subclassing. Keep templates/data as the source of truth; attach components at spawn time.

Where to Add New Things
-----------------------
- New enemy: add entry to `content/enemies.yaml`; ensure behavior id exists in `systems/ai.py`; spawn via `enemies/factory.spawn_enemy`.
- New AI behavior: add function in `systems/ai.py` keyed by behavior_id; reference the id in data.
- New action: add to `systems/actions.py`, expose in actions_catalog/content if data-driven, and wire into UI if player-usable.
- New pattern/fractal op: add generator/activation in `patterns/`; hook into `game.queue_player_fractal` and renderer ability bar.
- New scene/UI flow: add in `scenes/` and register via scene manager; reuse renderer/UI helpers.
- Map changes: local generation in `mapgen.py`; overworld visuals/interactions in `world_map_scene.py`.

Friend’s Notes (alignment)
--------------------------
- Actors (imps, player) are `Actor` instances in the energy queue; some Entities are non-Actors (e.g., berries).
+- `systems/actions.py` now contains many assignable actions; `systems/ai.py` has scripts used by NPC Actors.
- `monster_manual` (legacy) defines generic human; actual stats assigned at creation. We aim to move to YAML-driven templates.
- Action bar at bottom (renderer) should be generalizable for other special actions; extend `_build_abilities` in `render/ascii.py`.

Action Items to Reduce Fragmentation
------------------------------------
- Ignore/remove embedded repo `Edgecaster/Edgecaster` from outer index.
- Keep generated thumbnails/caches out of git.
- Migrate any remaining monster data from `content/monsters.py` to `content/enemies.yaml`; retire the stub.
- Consolidate fractal editing flows on `fractal_editor_scene.py` (use in character creation).
- Document new behaviors/actions in this file when adding them to avoid duplication.
